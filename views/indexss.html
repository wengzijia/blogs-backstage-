<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>layout 管理系统大布局 - Layui</title>
  <link rel="stylesheet" href="/static/layui-v2.6.8/layui/css/layui.css">
  <style>
    .c-gray {
      color: #ccc;
    }

    .c-green {
      color: green;
    }

    .c-red {
      color: red;
    }

    .photo {
      width: 300px;
      margin: auto;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .photo img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
    }
  </style>
</head>

<body>
  <div class="layui-layout layui-layout-admin">
    <div class="layui-header">
      <div class="layui-logo layui-hide-xs layui-bg-black">文章后台管理系统</div>
      <!-- 头部区域（可配合layui 已有的水平导航） -->
      <ul class="layui-nav layui-layout-left">
        <!-- 移动端显示 -->
        <li class="layui-nav-item layui-show-xs-inline-block layui-hide-sm" lay-header-event="menuLeft">
          <i class="layui-icon layui-icon-spread-left"></i>
        </li>

        <li class="layui-nav-item layui-hide-xs"><a href="">nav 1</a></li>
        <li class="layui-nav-item layui-hide-xs"><a href="">nav 2</a></li>
        <li class="layui-nav-item layui-hide-xs"><a href="">nav 3</a></li>
        <li class="layui-nav-item">
          <a href="javascript:;">nav groups</a>
          <dl class="layui-nav-child">
            <dd><a href="">menu 11</a></dd>
            <dd><a href="">menu 22</a></dd>
            <dd><a href="">menu 33</a></dd>
          </dl>
        </li>
      </ul>
      <ul class="layui-nav layui-layout-right">
        <li class="layui-nav-item layui-hide layui-show-md-inline-block">
          <a href="javascript:;">
            <img src="../static/image/a.jpg" class="layui-nav-img">
            头像
          </a>
          <dl class="layui-nav-child">
            <dd><a href="">你的个人信息</a></dd>
            <dd><a href="">设置</a></dd>
            <dd><a href="">退出</a></dd>
          </dl>
        </li>
        <li class="layui-nav-item" lay-header-event="menuRight" lay-unselect>
          <a href="javascript:;">
            <i class="layui-icon layui-icon-more-vertical"></i>
          </a>
        </li>
      </ul>
    </div>

    <div class="layui-side layui-bg-black">
      <div class="layui-side-scroll">
        <!-- 左侧导航区域（可配合layui已有的垂直导航） -->
        <ul class="layui-nav layui-nav-tree" lay-filter="test">
          <li class="layui-nav-item layui-nav-itemed">
            <a class="" href="javascript:;">文章管理</a>
            <dl class="layui-nav-child">
              <dd><a href="javascript:;">menu 1</a></dd>
              <dd><a href="javascript:;">menu 2</a></dd>
              <dd><a href="javascript:;">menu 3</a></dd>
              <dd><a href="">the links</a></dd>
            </dl>
          </li>
          <li class="layui-nav-item">
            <a href="javascript:;">分类管理</a>
            <dl class="layui-nav-child">
              <dd><a href="javascript:;">list 1</a></dd>
              <dd><a href="javascript:;">list 2</a></dd>
              <dd><a href="">超链接</a></dd>
            </dl>
          </li>
          <li class="layui-nav-item"><a href="javascript:;">点击菜单项</a></li>
          <li class="layui-nav-item"><a href="">VIP会员管理</a></li>
        </ul>
      </div>
    </div>

    <div class="layui-body">
      <!-- 内容主体区域 -->
      <div style="padding: 15px;">
        <h1 style="text-align: center;">文章列表</h1>
        <h2 style="text-align: center;">欢迎你:{{userInfo.username}},上一次登录时间:{{userInfo.last_login_date | dealDate}}</h2>
        <div class="photo">
          <button id="updAvatar">更换头像</button>
          <input type="file" id="avatarFile" style="display: none;">
          <img src="{{userInfo.avatar}}" alt="" id="preview">
        </div>
        <div style="text-align:center;padding:30px;">
          <button id="addBtn">添加文章</button>
          <a href="/recyclelist">回收站列表</a>
          <a href="/addImg">单文件上传</a>
          <a href="javascript:;" onclick="logout()">退出</a>
        </div>
        <div>
          <table align="center" width="1300px" border="1px" rules="all" class="layui-table" lay-skin="line">
            <tr>
              <td>序号</td>
              <td>标题</td>
              <td>所属分类</td>
              <td>图片</td>
              <td>作者</td>
              <td>内容</td>
              <td>状态</td>
              <td>添加时间</td>
              <td>修改时间</td>
              <td>操作</td>
            </tr>
            {{each article item index}}
            <tr>
              <td>{{index + 1}}</td>
              <td>{{item.title}}</td>
              <td>{{item.name}}</td>
              <td><img src="/{{item.img}}" width="100px" alt=""></td>
              <td>{{item.author}}</td>
              <td><a href="/detail?id={{item.id}}">查看详情</a></td>
              <td>{{@item.status_text}}</td>
              <td>{{item.addtime | dateFormat 'YYYY-MM-DD'}}</td>
              <td>{{item.updatetime | dateFormat 'YYYY-MM-DD'}}</td>
              <td>
                <a href="/edit?id={{item.id}}">编辑</a> |
                <a href="javascript:;" onclick="confirmDelete('{{item.id}}','{{item.img}}');">永久删除</a>
                <a href="/recycle?id={{item.id}}" onclick="return confirm('确实加入回收站吗?');">加入回收站</a>
                <a href="javascript:void(0)" onclick="ajaxDelete(this,'{{item.id}}','{{item.img}}')">ajax永久删除</a>
              </td>
            </tr>
            {{/each}}
          </table>
        </div>
      </div>
    </div>

    <div class="layui-footer">
      <!-- 底部固定区域 -->
      底部固定区域
    </div>
  </div>
</body>
<script src="/static/js/jquery.js"></script>
<script src="/static/layui-v2.6.8/layui/layui.js"></script>
<script>
  //JS 
  layui.use(['element', 'layer', 'util'], function () {
    var element = layui.element
      , layer = layui.layer
      , util = layui.util
      , $ = layui.$;

    //头部事件
    util.event('lay-header-event', {
      //左侧菜单事件
      menuLeft: function (othis) {
        layer.msg('展开左侧菜单的操作', { icon: 0 });
      }
      , menuRight: function () {
        layer.open({
          type: 1
          , content: '<div style="padding: 15px;">处理右侧面板的操作</div>'
          , area: ['260px', '100%']
          , offset: 'rt' //右上角
          , anim: 5
          , shadeClose: true
        });
      }
    });

  });


  // 隔行换色
  $("table tr:even").css("background-color", 'gold')
  $("tr:first").css("background-color", 'gold')
  $('#addBtn').click(function () {
    location.href = '/add'
  })

  // 退出
  function logout() {
    if (confirm('确认退出吗')) {
      location.href = "/logout"
    }
  }

  // 普通删除
  function confirmDelete(id, img) {

    // let result = layer.confirm('确认删除吗', {
    //     btn: ['是的', '取消'], //按钮
    //     shadeClose: true,
    //     shade: [0.3, '#000']
    // }, () => {
    //     //点了是的按钮触发
    //     location.href = "/delete?id=" + id
    // }, () => {
    //     layer.msg('你取消')
    // });
    // var index = layer.load(1, {
    //     shade: [0.1, '#fff'] //0.1透明度的白色背景
    // });


    layer.confirm('确认永久删除吗,数据不可还原', {
      btn: ['是的', '取消'] //按钮
    }, function () {

      layer.msg('删除成功', { icon: 1 });
      location.href = "/delete?id=" + id + "&img=" + img
    }, function () {
      layer.msg('删除失败', { icon: 2 })
    });
  }

  // ajax异步删除
  function ajaxDelete(ele, id, img) {
    // 找到他的祖先tr   parent() 找他的父亲
    // console.log($(ele).parent().parent())  

    layer.confirm('确认删除吗', {
      btn: ['是的', '取消'], // 按钮
      shadeClose: true,
      shade: [0.3, '#000']
    }, () => {
      // 点了是的按钮触发
      let xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function () {
        if (this.readyState === 4 && this.status === 200) {
          let data = JSON.parse(this.responseText);
          let { code, message } = data;
          if (code === 20000) {
            // 删除成功，删除当前tr行
            $(ele).parents('tr').remove();
            //延时器显示删除成功
            setTimeout(function () {
              layer.msg('删除成功', { icon: 1 })
            }, 500)
            // 疯狂模式,关闭所有层
            layer.closeAll();
          } else if (code === 30004) {
            console.log('code:', code)
            layer.msg(message)
            location.href = "/login"
          } else {
            layer.msg('删除失败')
          }
        }
      }
      xhr.open('post', '/ajaxdelete', true)
      xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded")
      xhr.send("id=" + id + "&img=" + img + "&flag=ajax")
    }, () => {
      layer.msg('否的')
    });
  }

  //ajax更新用户头像
  let avatarFile = document.getElementById('avatarFile');
  let preview = document.getElementById('preview');
  document.getElementById('updAvatar').onclick = function () {
    avatarFile.click();
  }


  // 给文件绑定onchange事件,来判断用户是否上传了文件
  avatarFile.onchange = function () {
    let file = this.files[0]; // 获取二进制数据
    if (!file) {
      return;
    }
    let formData = new FormData();
    formData.append('avatar', file);

    let xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function () {
      if (this.readyState === 4 && this.status === 200) {
        let data = JSON.parse(this.responseText);
        let { message, code, src } = data
          layer.msg(message)
          // 把服务器返回的图片路径设置img的src中，实现图片预览
          preview.src = '/' + src
      }
    }
    xhr.open('post', '/uploadAvatar', true)
    xhr.send(formData)

  }
</script>


</html>